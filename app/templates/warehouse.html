<!DOCTYPE html>
<html>
  <head>
    <title>Warehouse Inventory Charts</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body class="p-6 bg-gray-50">
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-2xl font-bold">Warehouse</h1>
      <div class="flex gap-6 items-center">
        <a href="/" class="text-blue-600 hover:underline">Dashboard</a>
        |
        <a href="/dimensions" class="text-blue-600 hover:underline"
          >Dimensions</a
        >
        |
        <a href="/facts" class="text-blue-600 hover:underline">Fact Tables</a>
        |
        <a href="/warehouse" class="text-blue-600 hover:underline">Warehouse</a>
      </div>
    </div>

    <!-- Snapshot Filter -->
    <div class="grid grid-cols-2 gap-6">
      <div>
        <div class="mb-4 flex gap-4 items-end">
          <div>
            <label class="block text-sm font-medium mb-1"
              >Snapshot Start Date</label
            >
            <input
              type="date"
              id="snapshotStart"
              class="border rounded px-2 py-1"
            />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1"
              >Snapshot End Date</label
            >
            <input
              type="date"
              id="snapshotEnd"
              class="border rounded px-2 py-1"
            />
          </div>
          <button
            id="loadSnapshotBtn"
            class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
          >
            Load Snapshot
          </button>
        </div>

        <!-- Inventory Snapshot Chart -->
        <div class="bg-white p-4 rounded-lg shadow mb-6">
          <h2 class="font-semibold mb-2">Daily Inventory Snapshot</h2>
          <canvas id="inventoryChart" width="800" height="400"></canvas>
        </div>
      </div>

      <!-- Movement Filter (Stacked per Warehouse) -->
      <div>
        <div class="mb-4 flex gap-4 items-end">
          <div>
            <label class="block text-sm font-medium mb-1"
              >Movement Start Date</label
            >
            <input
              type="date"
              id="movementStart"
              class="border rounded px-2 py-1"
            />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1"
              >Movement End Date</label
            >
            <input
              type="date"
              id="movementEnd"
              class="border rounded px-2 py-1"
            />
          </div>
          <button
            id="loadMovementBtn"
            class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700"
          >
            Load Movement
          </button>
        </div>

        <!-- Inventory Movement Stacked Bar Chart -->
        <div class="bg-white p-4 rounded-lg shadow">
          <h2 class="font-semibold mb-2">
            Inventory Movement per Warehouse (Stacked, Accumulation Facts Fact 3 Dims)
          </h2>
          <canvas id="movementStackedChart" width="800" height="400"></canvas>
        </div>
      </div>
    </div>

    <script>
      let inventoryChart = null;
      let movementStackedChart = null;
      const warehouse = 1;
      const product = 1;

      // Snapshot Chart
      async function loadSnapshot(start, end) {
        const res = await fetch(
          `/api/daily-inventory?start=${start}&end=${end}&warehouse=${warehouse}&product=${product}`
        );
        const data = await res.json();
        const labels = data.map((d) => d.date);
        const qtys = data.map((d) => d.on_hand_qty);

        const ctx = document.getElementById("inventoryChart").getContext("2d");
        if (inventoryChart) inventoryChart.destroy();
        inventoryChart = new Chart(ctx, {
          type: "line",
          data: {
            labels,
            datasets: [
              {
                label: "On-hand Quantity",
                data: qtys,
                borderColor: "blue",
                fill: false,
                tension: 0.1,
              },
            ],
          },
          options: {
            scales: {
              x: { title: { display: true, text: "Date" } },
              y: { title: { display: true, text: "Quantity" } },
            },
          },
        });
      }

      // Movement Stacked Bar Chart per Warehouse
      async function loadMovementStacked(start, end) {
        const res = await fetch(
          `/api/inventory-movement-stacked?start=${start}&end=${end}`
        );
        const data = await res.json(); // {labels: [...dates], datasets: [{label: warehouse, data: [...]}, ...]}

        const ctx = document
          .getElementById("movementStackedChart")
          .getContext("2d");
        if (movementStackedChart) movementStackedChart.destroy();

        movementStackedChart = new Chart(ctx, {
          type: "bar",
          data: {
            labels: data.labels,
            datasets: data.datasets.map((ds) => ({
              label: ds.label,
              data: ds.data,
              backgroundColor: `hsl(${Math.random() * 120}, 70%, 50%)`, // random color per warehouse
            })),
          },
          options: {
            responsive: true,
            plugins: { legend: { position: "top" } },
            scales: {
              x: { stacked: true, title: { display: true, text: "Date" } },
              y: {
                stacked: true,
                title: { display: true, text: "Total Quantity" },
              },
            },
          },
        });
      }

      // Default load
      const defaultStart = "2025-10-01";
      const defaultEnd = "2025-11-30";

      document.getElementById("snapshotStart").value = defaultStart;
      document.getElementById("snapshotEnd").value = defaultEnd;
      document.getElementById("movementStart").value = defaultStart;
      document.getElementById("movementEnd").value = defaultEnd;

      loadSnapshot(defaultStart, defaultEnd);
      loadMovementStacked(defaultStart, defaultEnd);

      // Event listeners
      document
        .getElementById("loadSnapshotBtn")
        .addEventListener("click", () => {
          const start = document.getElementById("snapshotStart").value;
          const end = document.getElementById("snapshotEnd").value;
          if (start && end) loadSnapshot(start, end);
        });

      document
        .getElementById("loadMovementBtn")
        .addEventListener("click", () => {
          const start = document.getElementById("movementStart").value;
          const end = document.getElementById("movementEnd").value;
          if (start && end) loadMovementStacked(start, end);
        });
    </script>
  </body>
</html>

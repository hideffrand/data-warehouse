<!DOCTYPE html>
<html>
  <head>
    <title>DW Sales Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>

  <body class="bg-gray-100">
    <!-- HEADER -->
    <div class="p-6">
      <div class="w-full flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold mb-6">DW Retail Dashboard</h1>
        <a href="/facts" class="text-blue-600 hover:underline">Fact Tables</a>
      </div>

      <!-- KPI -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
        <div class="bg-white p-6 rounded-xl shadow">
          <p class="text-gray-500 text-sm">Total Sales</p>
          <p class="text-2xl font-semibold">{{ total_sales }}</p>
        </div>
        <div class="bg-white p-6 rounded-xl shadow">
          <p class="text-gray-500 text-sm">Total Quantity</p>
          <p class="text-2xl font-semibold">{{ total_qty }}</p>
        </div>
        <div class="bg-white p-6 rounded-xl shadow">
          <p class="text-gray-500 text-sm">Total Transactions</p>
          <p class="text-2xl font-semibold">{{ total_trx }}</p>
        </div>
      </div>

      <!-- CHART GRID -->
      <div class="grid grid-cols-3 gap-6">
        <!-- Product Basket -->
        <div class="bg-white p-6 rounded-xl shadow">
          <h4 class="font-semibold mb-3">Frequently Bought Together</h4>
          <canvas id="basketChart"></canvas>
        </div>

        <!-- Payment Summary -->
        <div class="bg-white p-6 rounded-xl shadow">
          <h4 class="font-semibold mb-3">Payment Summary</h4>
          <canvas id="paymentChart"></canvas>
        </div>

        <!-- Top Products -->
        <div class="bg-white p-6 rounded-xl shadow">
          <h4 class="font-semibold mb-3">Top 5 Products</h4>
          <canvas id="topProductChart"></canvas>
        </div>

        <!-- Sales by Category -->
        <div class="bg-white p-6 rounded-xl shadow">
          <h4 class="font-semibold mb-3">Sales by Category</h4>
          <canvas id="categoryChart"></canvas>
        </div>

        <!-- Daily Sales (span 2 columns) -->
        <div class="bg-white p-6 rounded-xl shadow col-span-2">
          <h4 class="font-semibold mb-3">Daily Sales</h4>
          <canvas id="dailyChart"></canvas>
        </div>

        <!-- ====================== NEW FACT 1 ====================== -->
        <div class="bg-white p-6 rounded-xl shadow">
          <h4 class="font-semibold mb-3">Promotion Performance</h4>
          <canvas id="promotionChart"></canvas>
        </div>

        <!-- ====================== NEW FACT 2 ====================== -->
        <div class="bg-white p-6 rounded-xl shadow">
          <h4 class="font-semibold mb-3">Top Promo</h4>
          <canvas id="topPromoChart"></canvas>
        </div>

        <!-- ====================== NEW FACT 3 ====================== -->
        <div class="bg-white p-6 rounded-xl shadow">
          <h4 class="font-semibold mb-3">Sales by Region</h4>
          <canvas id="regionChart"></canvas>
        </div>
      </div>
    </div>

    <script>
        // ================= Daily Sales =====================
        const dailyLabels = {{ daily | map(attribute=0) | list | tojson }};
        const dailyValues = {{ daily | map(attribute=1) | list | tojson }};

        new Chart(document.getElementById("dailyChart"), {
            type: "line",
            data: {
                labels: dailyLabels,
                datasets: [{
                    label: "Daily Sales",
                    data: dailyValues,
                    borderWidth: 2,
                    borderColor: "#0984e3",
                    backgroundColor: "rgba(9,132,227,0.2)",
                    tension: 0.3,
                }]
            }
        });

        // ================= Payment Summary =================
        const paymentLabels = {{ payment | map(attribute=0) | list | tojson }};
        const paymentValues = {{ payment | map(attribute=1) | list | tojson }};

        new Chart(document.getElementById("paymentChart"), {
            type: "bar",
            data: {
                labels: paymentLabels,
                datasets: [{
                    label: "Sales by Payment",
                    data: paymentValues
                }]
            }
        });

        // ================= Top Products ====================
        const topLabels = {{ top_products | map(attribute=0) | list | tojson }};
        const topValues = {{ top_products | map(attribute=1) | list | tojson }};

        new Chart(document.getElementById("topProductChart"), {
            type: "bar",
            data: {
                labels: topLabels,
                datasets: [{
                    label: "Top Selling Products",
                    data: topValues
                }]
            }
        });

        // ================= Category Sales ==================
        const categoryLabels = {{ sales_by_category | map(attribute=0) | list | tojson }};
        const categoryValues = {{ sales_by_category | map(attribute=1) | list | tojson }};

        new Chart(document.getElementById("categoryChart"), {
            type: "pie",
            data: {
                labels: categoryLabels,
                datasets: [{
                    data: categoryValues
                }]
            }
        });

        // ================= Basket Frequency ================
        const basketLabels = {{ basket_freq | map(attribute=0) | list | tojson }};
        const basketValues = {{ basket_freq | map(attribute=1) | list | tojson }};

        new Chart(document.getElementById("basketChart"), {
            type: "bar",
            data: {
                labels: basketLabels,
                datasets: [{
                    label: "Basket Frequency",
                    data: basketValues
              }]
          }
      });
    </script>
    <!-- ===================== PROMOTION PERFORMANCE CHART ===================== -->
    <script>
      const promoSummary = {{ promo_summary | tojson }};
      const promoLabels = promoSummary.map(row => row[0]);
      const promoValues = promoSummary.map(row => row[3]);

      new Chart(document.getElementById("promotionChart"), {
          type: "bar",
          data: {
              labels: promoLabels,
              datasets: [{
                  label: "Total Sales by Promotion",
                  data: promoValues
              }]
          }
      });

      // ===================== TOP PROMOTIONS CHART =====================
      const topPromotions = {{ top_promotions | tojson }};
      const topPromoLabels = topPromotions.map(row => row[0]);
      const topPromoValues = topPromotions.map(row => row[2]);

      new Chart(document.getElementById("topPromoChart"), {
          type: "bar",
          data: {
              labels: topPromoLabels,
              datasets: [{
                  label: "Top Promotion Sales",
                  data: topPromoValues
              }]
          }
      });

      // ===================== SALES BY REGION =====================
      const regionData = {{ sales_by_region | tojson }};
      const regionLabels = regionData.map(row => row[0]);
      const regionValues = regionData.map(row => row[1]);

      new Chart(document.getElementById("regionChart"), {
          type: "pie",
          data: {
              labels: regionLabels,
              datasets: [{
                  label: "Sales by Region",
                  data: regionValues
              }]
          }
      });
    </script>
  </body>
</html>
